<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/list.css">
    <title>質問・返答一覧</title>
</head>

<body>
    <div class="wrapper">
        <header class="header">
            <div>
                <img src="/img/hackit.png" alt="Hackit Logo" class="logo">
            </div>
            <nav class="nav">
                <ul>
                    <li><a href="/">ホーム</a></li>
                    <li><a href="/contributor/new">過去問投稿</a></li>
                    <li><a href="/viewer/question/list" class="active">質問・返答</a></li>
                    <li><a href="/login">ログイン</a></li>
                </ul>
            </nav>
        </header>

        <main class="container">
            <div class="page-header">
                <h1>質問・返答一覧</h1>
                <a href="/viewer/question/new" class="new-question-btn">新しい質問をする</a>
            </div>

            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="質問を検索...">
                    <button type="button" class="search-btn">検索</button>
                </div>
                <div class="filter-options">
                    <select id="category-filter">
                        <option value="all">すべての課程</option>
                        <option value="修学基礎">修学基礎</option>
                        <option value="人間形成基礎">人間形成基礎</option>
                        <option value="生涯スポーツ">生涯スポーツ</option>
                        <option value="英語">英語</option>
                        <option value="数理基礎">数理基礎</option>
                        <option value="基礎プロジェクト">基礎プロジェクト</option>
                        <option value="教職">教職</option>
                        <option value="文理横断">文理横断</option>
                        <option value="専門">専門</option>
                        <option value="その他">その他</option>
                    </select>
                    <select id="status-filter">
                        <option value="all">すべてのステータス</option>
                        <option value="answered">回答済み</option>
                        <option value="unanswered">未回答</option>
                    </select>
                </div>
            </div>

            <div class="questions-container">
                <!-- 質問カードはJavaScriptによって動的に生成されます -->
            </div>

            <!-- ページネーション -->
            <div class="pagination">
                <button class="page-btn" disabled>前へ</button>
                <span class="page-info">1 / 1</span>
                <button class="page-btn" disabled>次へ</button>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <p><a href="/#">利用規約</a></p>
                <p>&copy; 2025 Hackit さぁ、きっと。</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "firebase/auth";
        import '/firebase.js';

        async function renderQuestions() {
            const questionsContainer = document.querySelector('.questions-container');
            if (!questionsContainer) return;

            questionsContainer.innerHTML = '<p>質問を読み込んでいます...</p>';

            try {
                const snapshot = await window.getQuestions();
                if (snapshot.empty) {
                    questionsContainer.innerHTML = '<p>まだ質問がありません。</p>';
                    return;
                }

                questionsContainer.innerHTML = ''; // ローディングメッセージをクリア

                snapshot.forEach(doc => {
                    const question = doc.data();
                    const questionId = doc.id;

                    const card = document.createElement('div');
                    card.className = 'question-card';
                    card.dataset.category = question.course_label.toLowerCase();
                    card.dataset.status = question.is_solved ? 'answered' : 'unanswered';
                    
                    const solvedStatus = question.is_solved 
                        ? '<span class="status answered">回答済み</span>' 
                        : '<span class="status unanswered">未回答</span>';
                    
                    const contentPreview = question.content ? question.content.substring(0, 100) + (question.content.length > 100 ? '...' : '') : '';

                    card.innerHTML = `
                        <div class="question-header">
                            <span class="category-tag">${question.course_label || 'カテゴリなし'}</span>
                            ${solvedStatus}
                        </div>
                        <h3 class="question-title">${question.title}</h3>
                        <p class="question-preview">${contentPreview}</p>
                        <div class="question-meta">
                            <span class="author">投稿者: ${question.user.name || '匿名'}</span>
                            <span class="date">${question.date ? question.date.toDate().toLocaleString('ja-JP') : '日付不明'}</span>
                            <span class="answers-count">回答数: ${question.ans_count}</span>
                        </div>
                        <div class="question-actions">
                            <a href="/viewer/question/detail.html?id=${questionId}" class="view-btn">詳細を見る</a>
                            <button class="like-btn">👍 ${question.good_count}</button>
                        </div>
                    `;
                    questionsContainer.appendChild(card);
                });
            } catch (error) {
                console.error("質問の読み込みに失敗しました:", error);
                questionsContainer.innerHTML = '<p>質問の読み込み中にエラーが発生しました。</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const auth = getAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    renderQuestions();
                } else {
                    window.location.href = '/login.html';
                }
            });
        });
    </script>
    <script src="/js/question-list.js" defer></script>
</body>

</html>