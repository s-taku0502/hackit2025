<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ホーム画面</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/index.css">
</head>

<body>
    <div class="wrapper">
        <header class="header">
            <div>
                <img src="/img/hackit.png" alt="Hackit Logo" class="logo">
            </div>
            <nav class="nav">
                <ul>
                    <li><a href="/index.html">ホーム</a></li> <li><a href="/contributor/new.html">過去問投稿</a></li>
                    <li><a href="/viewer/question/list.html">質問・返答</a></li>
                    <li><a href="/login.html">ログイン</a></li>
                </ul>
            </nav>
        </header>

        <main class="container">
            <h1 class="username">ようこそ, ゲストさん!</h1>
            
            <h2 class="past-papers">過去問一覧</h2>
            <a href="/viewer/past_quesion/past_questions_all.html">
                <img src="/img/pastpaper.png" alt="過去問一覧" class="pastpapers">
            </a>

            <h2 class="recent-q-and-a">最近のQ&A</h2>
            <a href="/viewer/question/list.html">
                <img src="/img/Q&A.png" alt="最近のQ&A" class="recentQandA">
            </a>

            <h2 class="recommend-for-you">過去問履歴</h2>
            <a href="/viewer/question_history.html">
                <img src="/img/recent for you.png" alt="過去問履歴" class="recent">
            </a>

            <ul id="history-list">
                </ul>
        </main>

        <footer class="site-footer">
            <div class="footer-content">
                <p><a href="/privacy-policy" class="footer-link">プライバシーポリシー</a></p>
                <p><a href="/terms" class="footer-link">利用規約</a></p>
                <p>&copy; 2025 Hackit さぁ、きっと。</p>
            </div>
        </footer>
    </div> <script type="module" src="/firebase.js"></script> <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            const usernameElement = document.querySelector('.username');

            // window.onAuth が定義されていることを確認
            if (window.onAuth) {
                window.onAuth(async (user) => {
                    if (user) {
                        const userProfile = await window.getUserProfile(user.uid);
                        if (userProfile && userProfile.exists()) {
                            usernameElement.textContent = `ようこそ, ${userProfile.data().username}さん!`;
                        } else {
                            usernameElement.textContent = 'ようこそ, ユーザーさん!';
                        }
                    } else {
                        // ログインしていない場合はログインページへリダイレクト
                        window.location.href = '/login.html';
                    }
                });
            } else {
                console.warn("window.onAuth is not defined. Ensure firebase.js is loaded correctly.");
            }

            const historyList = document.getElementById('history-list');
            if (historyList) {
                // Firebase Firestoreモジュールの動的インポートをCDNパスに変更
                const { getFirestore, collection, getDocs, orderBy, query, where } = await import("https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js");
                const db = getFirestore();
                
                const q = query(collection(db, "history"), orderBy("time", "desc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    historyList.innerHTML = '<li>閲覧履歴はまだありません</li>';
                } else {
                    const urlMap = new Map();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.url && !urlMap.has(data.url)) {
                            urlMap.set(data.url, { ...data });
                        }
                    });

                    const urlEntries = Array.from(urlMap.entries()).slice(0, 10);
                    const urlList = urlEntries.map(([url]) => url);
                    let filesData = {};

                    if (urlList.length > 0) {
                        const urlChunks = [];
                        for (let i = 0; i < urlList.length; i += 10) {
                            urlChunks.push(urlList.slice(i, i + 10));
                        }
                        for (const chunk of urlChunks) {
                            const filesQ = query(collection(db, "files"), where("url", "in", chunk));
                            const filesSnap = await getDocs(filesQ);
                            filesSnap.forEach(doc => {
                                const d = doc.data();
                                if (d.url) filesData[d.url] = d;
                            });
                        }
                    }

                    urlEntries.forEach(([url, data]) => {
                        const file = filesData[url] || {};
                        const dateStr = data.time && data.time.toDate ? data.time.toDate().toLocaleString() : '';
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${url}" target="_blank" class="pdf-link">${file.year || ''} ${file.name || ''} ${file.teacher || ''}</a> <span style="font-size:0.9em;color:#888;">${dateStr}</span>`;
                        historyList.appendChild(li);
                    });
                }
            }
        });
    </script>
</body>

</html>